<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrintLoyalty - Sistema de Fidelizaci√≥n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .config-banner {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            margin: 0;
            text-align: center;
            font-weight: 600;
        }

        .config-banner.connected {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            flex-wrap: wrap;
        }
        
        .tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            min-width: 120px;
        }
        
        .tab.active {
            background: white;
            color: #4CAF50;
            border-bottom: 3px solid #4CAF50;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .points-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .points-display {
            font-size: 3rem;
            font-weight: bold;
            margin: 20px 0;
        }
        
        .client-search {
            margin-bottom: 30px;
        }
        
        .search-box {
            width: 100%;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 1.1rem;
            margin-bottom: 15px;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .service-card {
            border: 2px solid #dee2e6;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s;
        }
        
        .service-card:hover {
            border-color: #4CAF50;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .service-title {
            color: #4CAF50;
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .service-points {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .price-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .rewards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .reward-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .reward-card:hover {
            border-color: #4CAF50;
            transform: scale(1.05);
        }
        
        .reward-points {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 15px;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow-x: auto;
        }
        
        .history-table th, .history-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .history-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .client-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .points-calculation {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .config-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .step-number {
            background: #4CAF50;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                flex: none;
                padding: 15px;
                font-size: 1rem;
            }
            
            .services-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üñ®Ô∏è PrintLoyalty</h1>
            <p>Sistema de Fidelizaci√≥n con Google Sheets</p>
        </div>
        
        <div id="configBanner" class="config-banner">
            ‚ö†Ô∏è Configura tu Google Sheet para comenzar - Ve a la pesta√±a "Configuraci√≥n"
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('config')">‚öôÔ∏è Configuraci√≥n</button>
            <button class="tab" onclick="showTab('consulta')">üë§ Consultar Cliente</button>
            <button class="tab" onclick="showTab('registrar')">üìù Registrar Venta</button>
            <button class="tab" onclick="showTab('recompensas')">üéÅ Recompensas</button>
            <button class="tab" onclick="showTab('admin')">üìä Admin</button>
        </div>
        
        <!-- TAB: Configuraci√≥n -->
        <div id="config" class="tab-content active">
            <div class="config-section">
                <h2>üîß Configurar Google Sheets</h2>
                <p style="margin-bottom: 30px; font-size: 1.1rem; color: #666;">Conecta tu Google Sheet para que el sistema funcione correctamente:</p>
                
                <div style="margin-bottom: 30px;">
                    <div class="step-number">1</div>
                    <h3 style="display: inline-block; margin-bottom: 15px;">ID de tu Google Sheet</h3>
                    <p style="margin-bottom: 15px; color: #666;">Pega aqu√≠ el ID de tu Google Sheet (la parte entre /d/ y /edit en la URL):</p>
                    <input type="text" id="sheetId" class="search-box" placeholder="Ejemplo: 1ABC123DEF456GHI789JKL..." style="font-family: monospace;">
                    <small style="color: #888;">üí° El ID es una cadena larga de letras y n√∫meros</small>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <button class="btn" onclick="saveConfig()">üíæ Guardar Configuraci√≥n</button>
                    <button class="btn btn-secondary" onclick="testConnection()">üîç Probar Conexi√≥n</button>
                </div>
                
                <div id="configStatus" style="margin-top: 20px;"></div>
            </div>
            
            <div class="config-section">
                <div class="step-number">2</div>
                <h3 style="display: inline-block; margin-bottom: 15px;">Configurar las Hojas</h3>
                <p style="margin-bottom: 15px;">Aseg√∫rate de tener estas hojas con estos nombres exactos:</p>
                
                <div style="background: white; padding: 20px; border-radius: 10px; margin: 15px 0;">
                    <h4>üìä Hoja "Clientes"</h4>
                    <p style="margin: 10px 0;">En la fila 1, agrega estas columnas:</p>
                    <code style="background: #f1f1f1; padding: 5px; display: block; margin: 10px 0;">ID | Nombre | Tel√©fono | Email | Puntos | Total_Gastado | Compras</code>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px; margin: 15px 0;">
                    <h4>üìã Hoja "Historial"</h4>
                    <p style="margin: 10px 0;">En la fila 1, agrega estas columnas:</p>
                    <code style="background: #f1f1f1; padding: 5px; display: block; margin: 10px 0;">Cliente_ID | Fecha | Servicio | Monto | Puntos | Tipo</code>
                </div>
            </div>
            
            <div class="config-section">
                <div class="step-number">3</div>
                <h3 style="display: inline-block; margin-bottom: 15px;">Instrucciones Paso a Paso</h3>
                <ol style="padding-left: 30px; line-height: 2;">
                    <li>Ve a <a href="https://sheets.google.com" target="_blank" style="color: #4CAF50;">sheets.google.com</a></li>
                    <li>Crea una nueva hoja llamada <strong>"Sistema Fidelizaci√≥n - Imprenta"</strong></li>
                    <li>Renombra la primera hoja a <strong>"Clientes"</strong></li>
                    <li>En la fila 1 de "Clientes", agrega: <code>ID | Nombre | Tel√©fono | Email | Puntos | Total_Gastado | Compras</code></li>
                    <li>Crea una segunda hoja llamada <strong>"Historial"</strong></li>
                    <li>En la fila 1 de "Historial", agrega: <code>Cliente_ID | Fecha | Servicio | Monto | Puntos | Tipo</code></li>
                    <li>Haz clic en <strong>"Compartir"</strong> ‚Üí <strong>"Cualquier persona con el enlace"</strong> ‚Üí <strong>"Editor"</strong></li>
                    <li>Copia el ID del sheet (entre /d/ y /edit en la URL) y p√©galo arriba ‚¨ÜÔ∏è</li>
                </ol>
            </div>
        </div>
        
        <!-- TAB: Consultar Cliente -->
        <div id="consulta" class="tab-content">
            <div class="client-search">
                <h2>üîç Buscar Cliente</h2>
                <input type="text" id="searchClient" class="search-box" placeholder="Ingresa tel√©fono, nombre o email del cliente">
                <button class="btn" onclick="searchClient()" id="searchBtn">Buscar Cliente</button>
                <button class="btn btn-secondary" onclick="addNewClient()">+ Agregar Nuevo</button>
            </div>
            
            <div id="searchLoading" class="loading" style="display:none;">
                üîÑ Buscando cliente...
            </div>
            
            <div id="clientResult" style="display:none;">
                <div class="points-card">
                    <h3>Cliente: <span id="clientName"></span></h3>
                    <div class="points-display" id="clientPoints">0</div>
                    <p>Puntos Acumulados</p>
                    <p>Pr√≥xima recompensa en: <span id="nextReward"></span> puntos</p>
                </div>
                
                <div class="client-info">
                    <p><strong>Tel√©fono:</strong> <span id="clientPhone"></span></p>
                    <p><strong>Email:</strong> <span id="clientEmail"></span></p>
                    <p><strong>Total gastado:</strong> $<span id="clientTotal"></span></p>
                    <p><strong>Compras realizadas:</strong> <span id="clientPurchases"></span></p>
                </div>
                
                <h3>üìã Historial de Compras</h3>
                <div style="overflow-x: auto;">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Servicio</th>
                                <th>Monto</th>
                                <th>Puntos</th>
                            </tr>
                        </thead>
                        <tbody id="clientHistory">
                            <!-- Historial din√°mico -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- TAB: Registrar Venta -->
        <div id="registrar" class="tab-content">
            <h2>üí∞ Registrar Nueva Venta</h2>
            
            <div class="client-search">
                <input type="text" id="saleClientSearch" class="search-box" placeholder="Buscar cliente por tel√©fono o nombre">
                <button class="btn" onclick="findClientForSale()">Buscar Cliente</button>
            </div>
            
            <div id="saleClientInfo" style="display:none;" class="client-info">
                <p><strong>Cliente:</strong> <span id="saleClientName"></span></p>
                <p><strong>Puntos actuales:</strong> <span id="saleClientPoints"></span></p>
            </div>
            
            <div class="services-grid">
                <div class="service-card">
                    <div class="service-title">üìÑ Impresi√≥n B/N</div>
                    <div class="service-points">1 punto cada $50 ‚Ä¢ Sin bonificaci√≥n</div>
                    <input type="number" class="price-input" id="bn-price" placeholder="Monto total ($)">
                    <button class="btn" onclick="calculatePoints('bn', document.getElementById('bn-price').value)">Calcular Puntos</button>
                </div>
                
                <div class="service-card">
                    <div class="service-title">üåà Impresi√≥n Color</div>
                    <div class="service-points">1 punto cada $50 ‚Ä¢ Sin bonificaci√≥n</div>
                    <input type="number" class="price-input" id="color-price" placeholder="Monto total ($)">
                    <button class="btn" onclick="calculatePoints('color', document.getElementById('color-price').value)">Calcular Puntos</button>
                </div>
                
                <div class="service-card">
                    <div class="service-title">üìã Con Anillado</div>
                    <div class="service-points">1 punto cada $50 ‚Ä¢ Sin bonificaci√≥n</div>
                    <input type="number" class="price-input" id="anillado-price" placeholder="Monto total ($)">
                    <button class="btn" onclick="calculatePoints('anillado', document.getElementById('anillado-price').value)">Calcular Puntos</button>
                </div>
                
                <div class="service-card">
                    <div class="service-title">‚ú® Papel Especial</div>
                    <div class="service-points">1 punto cada $50 ‚Ä¢ +25% si >$2000</div>
                    <input type="number" class="price-input" id="especial-price" placeholder="Monto total ($)">
                    <button class="btn" onclick="calculatePoints('especial', document.getElementById('especial-price').value)">Calcular Puntos</button>
                </div>
                
                <div class="service-card">
                    <div class="service-title">üè≠ Trabajo Offset</div>
                    <div class="service-points">1 punto cada $50 ‚Ä¢ +50% puntos siempre</div>
                    <input type="number" class="price-input" id="offset-price" placeholder="Monto total ($)">
                    <button class="btn" onclick="calculatePoints('offset', document.getElementById('offset-price').value)">Calcular Puntos</button>
                </div>
            </div>
            
            <div id="pointsCalculation" style="display:none;" class="points-calculation">
                <h3>üíé C√°lculo de Puntos</h3>
                <p><strong>Servicio:</strong> <span id="calcService"></span></p>
                <p><strong>Monto:</strong> $<span id="calcAmount"></span></p>
                <p><strong>Puntos base:</strong> <span id="calcBase"></span></p>
                <p><strong>Bonificaci√≥n:</strong> <span id="calcBonus"></span></p>
                <p><strong>Total puntos:</strong> <span id="calcTotal"></span> puntos</p>
                <button class="btn" onclick="confirmSale()">‚úÖ Confirmar Venta</button>
                <button class="btn btn-secondary" onclick="cancelSale()">‚ùå Cancelar</button>
            </div>
        </div>
        
        <!-- TAB: Recompensas -->
        <div id="recompensas" class="tab-content">
            <h2>üéÅ Cat√°logo de Recompensas</h2>
            
            <div class="rewards-grid">
                <div class="reward-card">
                    <div class="reward-points">200 pts</div>
                    <h3>50 Copias B/N Gratis</h3>
                    <p>V√°lido para impresiones simples en papel bond</p>
                </div>
                
                <div class="reward-card">
                    <div class="reward-points">400 pts</div>
                    <h3>15% Descuento</h3>
                    <p>En cualquier servicio de la imprenta</p>
                </div>
                
                <div class="reward-card">
                    <div class="reward-points">600 pts</div>
                    <h3>Anillado Gratis</h3>
                    <p>Con cualquier impresi√≥n mayor a 20 hojas</p>
                </div>
                
                <div class="reward-card">
                    <div class="reward-points">800 pts</div>
                    <h3>100 Copias Color Gratis</h3>
                    <p>V√°lido para impresiones en papel fotogr√°fico</p>
                </div>
                
                <div class="reward-card">
                    <div class="reward-points">1000 pts</div>
                    <h3>25% Descuento Premium</h3>
                    <p>En trabajos de offset o gran volumen</p>
                </div>
                
                <div class="reward-card">
                    <div class="reward-points">1500 pts</div>
                    <h3>Dise√±o B√°sico Gratis</h3>
                    <p>Flyer, tarjeta personal o volante simple</p>
                </div>
            </div>
            
            <div style="margin-top: 40px; text-align: center;">
                <h3>üîÑ Canjear Recompensa</h3>
                <input type="text" class="search-box" placeholder="Tel√©fono del cliente" id="redeemClient" style="margin-bottom: 15px;">
                <select class="search-box" id="redeemReward">
                    <option value="">Seleccionar recompensa...</option>
                    <option value="200">50 Copias B/N Gratis (200 pts)</option>
                    <option value="400">15% Descuento (400 pts)</option>
                    <option value="600">Anillado Gratis (600 pts)</option>
                    <option value="800">100 Copias Color Gratis (800 pts)</option>
                    <option value="1000">25% Descuento Premium (1000 pts)</option>
                    <option value="1500">Dise√±o B√°sico Gratis (1500 pts)</option>
                </select>
                <button class="btn" onclick="redeemReward()">üéÅ Canjear Recompensa</button>
            </div>
        </div>
        
        <!-- TAB: Admin -->
        <div id="admin" class="tab-content">
            <h2>üìä Panel de Administraci√≥n</h2>
            
            <div id="adminLoading" class="loading">
                üîÑ Cargando estad√≠sticas...
            </div>
            
            <div id="adminContent" style="display:none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalClients">0</div>
                        <div class="stat-label">Clientes Registrados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalSales">$0</div>
                        <div class="stat-label">Ventas Totales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalPoints">0</div>
                        <div class="stat-label">Puntos Otorgados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeClients">0</div>
                        <div class="stat-label">Clientes Activos</div>
                    </div>
                </div>
                
                <h3>üëë Top 10 Clientes VIP</h3>
                <div style="overflow-x: auto;">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Puntos</th>
                                <th>Total Gastado</th>
                                <th>Compras</th>
                            </tr>
                        </thead>
                        <tbody id="topClients">
                            <!-- Top clientes din√°mico -->
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 30px;">
                    <button class="btn" onclick="refreshData()">üîÑ Actualizar Datos</button>
                    <button class="btn btn-secondary" onclick="viewSheet()">üìä Ver Google Sheet</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n Google Sheets
        let SHEET_ID = '';
        let CLIENTS_SHEET = 'Clientes';
        let HISTORY_SHEET = 'Historial';
        let isConfigured = false;
        
        // Cache local
        let clientsCache = [];
        let historyCache = [];
        let currentSaleClient = null;
        let pendingSale = null;
        
        // Inicializaci√≥n
        window.onload = function() {
            loadConfig();
            if (isConfigured) {
                updateConfigBanner(true);
            } else {
                showTab('config');
            }
        };
        
        function loadConfig() {
            const savedSheetId = localStorage.getItem('loyalty_sheet_id');
            if (savedSheetId) {
                SHEET_ID = savedSheetId;
                document.getElementById('sheetId').value = savedSheetId;
                isConfigured = true;
                updateConfigBanner(true);
            }
        }
        
        function saveConfig() {
            const sheetId = document.getElementById('sheetId').value.trim();
            if (!sheetId) {
                alert('Por favor ingresa el ID de tu Google Sheet');
                return;
            }
            
            SHEET_ID = sheetId;
            localStorage.setItem('loyalty_sheet_id', sheetId);
            isConfigured = true;
            updateConfigBanner(true);
            
            document.getElementById('configStatus').innerHTML = '<div style="color: green; margin-top: 15px; padding: 15px; background: #d4edda; border-radius: 8px;">‚úÖ Configuraci√≥n guardada correctamente. Ahora prueba la conexi√≥n.</div>';
        }
        
        function updateConfigBanner(connected) {
            const banner = document.getElementById('configBanner');
            if (connected) {
                banner.innerHTML = '‚úÖ Google Sheet configurado - Sistema listo para usar';
                banner.className = 'config-banner connected';
            } else {
                banner.innerHTML = '‚ö†Ô∏è Configura tu Google Sheet para comenzar - Ve a la pesta√±a "Configuraci√≥n"';
                banner.className = 'config-banner';
            }
        }
        
        async function testConnection() {
            if (!SHEET_ID) {
                alert('Primero guarda la configuraci√≥n');
                return;
            }
            
            const statusDiv = document.getElementById('configStatus');
            statusDiv.innerHTML = '<div style="color: #856404; margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 8px;">üîÑ Probando conexi√≥n...
                C√≥digo completo con JavaScript
