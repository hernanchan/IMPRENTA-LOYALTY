<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrintLoyalty - Sistema de Fidelizaci√≥n</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(90deg, #4CAF50, #45a049); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        .config-banner { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; margin: 0; text-align: center; font-weight: 600; }
        .config-banner.connected { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid #dee2e6; flex-wrap: wrap; }
        .tab { flex: 1; padding: 15px 10px; text-align: center; background: none; border: none; cursor: pointer; font-size: 0.9rem; font-weight: 600; color: #666; transition: all 0.3s; min-width: 120px; }
        .tab.active { background: white; color: #4CAF50; border-bottom: 3px solid #4CAF50; }
        .tab:hover { background: #e9ecef; }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        .points-card { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center; }
        .points-display { font-size: 3rem; font-weight: bold; margin: 20px 0; }
        .client-search { margin-bottom: 30px; }
        .search-box { width: 100%; padding: 15px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 1.1rem; margin-bottom: 15px; }
        .search-box:focus { outline: none; border-color: #4CAF50; }
        .btn { background: #4CAF50; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s; margin: 5px; }
        .btn:hover { background: #45a049; transform: translateY(-2px); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .services-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 30px 0; }
        .service-card { border: 2px solid #dee2e6; border-radius: 15px; padding: 25px; transition: all 0.3s; }
        .service-card:hover { border-color: #4CAF50; transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .service-title { color: #4CAF50; font-size: 1.3rem; font-weight: bold; margin-bottom: 10px; }
        .service-points { color: #666; font-size: 0.9rem; margin-bottom: 15px; }
        .price-input { width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; margin-bottom: 15px; }
        .rewards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .reward-card { background: #f8f9fa; border-radius: 15px; padding: 25px; text-align: center; transition: all 0.3s; border: 2px solid transparent; }
        .reward-card:hover { border-color: #4CAF50; transform: scale(1.05); }
        .reward-points { background: #4CAF50; color: white; padding: 10px 20px; border-radius: 25px; font-weight: bold; display: inline-block; margin-bottom: 15px; }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 20px; overflow-x: auto; }
        .history-table th, .history-table td { padding: 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
        .history-table th { background: #f8f9fa; font-weight: 600; color: #333; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 25px; border-radius: 15px; text-align: center; }
        .stat-number { font-size: 2.5rem; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 0.9rem; opacity: 0.9; }
        .client-info { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .points-calculation { background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .loading { text-align: center; padding: 20px; color: #666; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .config-section { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
        .step-number { background: #4CAF50; color: white; border-radius: 50%; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; }
        @media (max-width: 768px) { .tabs { flex-direction: column; } .tab { flex: none; padding: 15px; font-size: 1rem; } .services-grid { grid-template-columns: 1fr; } .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üñ®Ô∏è PrintLoyalty</h1>
            <p>Sistema de Fidelizaci√≥n 100% Funcional</p>
        </div>
        
        <div id="configBanner" class="config-banner">
            ‚ö†Ô∏è Configura tu API de Google Apps Script
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('config')">‚öôÔ∏è Configuraci√≥n</button>
            <button class="tab" onclick="showTab('consulta')">üë§ Consultar Cliente</button>
            <button class="tab" onclick="showTab('registrar')">üìù Registrar Venta</button>
            <button class="tab" onclick="showTab('recompensas')">üéÅ Recompensas</button>
            <button class="tab" onclick="showTab('admin')">üìä Admin</button>
        </div>
        
        <div id="config" class="tab-content active">
            <div class="config-section">
                <h2>üîß Configurar API</h2>
                <div style="margin-bottom: 30px;">
                    <h3>URL de tu Google Apps Script</h3>
                    <p style="margin-bottom: 15px;">Pega aqu√≠ la URL que termina en /exec:</p>
                    <input type="text" id="apiUrl" class="search-box" placeholder="https://script.google.com/macros/s/.../exec">
                </div>
                <button class="btn" onclick="saveApiConfig()">üíæ Guardar API</button>
                <button class="btn btn-secondary" onclick="testApi()">üîç Probar API</button>
                <div id="configStatus"></div>
            </div>
            
            <div class="config-section">
                <h2>üìã Instrucciones</h2>
                <ol style="padding-left: 30px; line-height: 2;">
                    <li>Crea tu Google Apps Script con el c√≥digo que te di</li>
                    <li>Cambia el SHEET_ID en la l√≠nea 4</li>
                    <li>Implementa como aplicaci√≥n web</li>
                    <li>Copia la URL que termina en /exec</li>
                    <li>P√©gala aqu√≠ arriba ‚¨ÜÔ∏è</li>
                </ol>
            </div>
        </div>
        
        <div id="consulta" class="tab-content">
            <h2>üîç Buscar Cliente</h2>
            <input type="text" id="searchClient" class="search-box" placeholder="Tel√©fono, nombre o email">
            <button class="btn" onclick="searchClient()">Buscar</button>
            <button class="btn btn-secondary" onclick="showAddClientForm()">+ Agregar Nuevo</button>
            
            <div id="addClientForm" style="display:none;" class="config-section">
                <h3>‚ûï Agregar Nuevo Cliente</h3>
                <input type="text" id="newClientName" class="search-box" placeholder="Nombre completo">
                <input type="text" id="newClientPhone" class="search-box" placeholder="Tel√©fono">
                <input type="email" id="newClientEmail" class="search-box" placeholder="Email (opcional)">
                <button class="btn" onclick="addNewClient()">Agregar Cliente</button>
                <button class="btn btn-secondary" onclick="cancelAddClient()">Cancelar</button>
            </div>
            
            <div id="searchLoading" class="loading" style="display:none;">üîÑ Buscando...</div>
            
            <div id="clientResult" style="display:none;">
                <div class="points-card">
                    <h3>Cliente: <span id="clientName"></span></h3>
                    <div class="points-display" id="clientPoints">0</div>
                    <p>Puntos Acumulados</p>
                    <p>Pr√≥xima recompensa en: <span id="nextReward"></span> puntos</p>
                </div>
                
                <div class="client-info">
                    <p><strong>Tel√©fono:</strong> <span id="clientPhone"></span></p>
                    <p><strong>Email:</strong> <span id="clientEmail"></span></p>
                    <p><strong>Total gastado:</strong> $<span id="clientTotal"></span></p>
                    <p><strong>Compras realizadas:</strong> <span id="clientPurchases"></span></p>
                </div>
                
                <h3>üìã Historial de Compras</h3>
                <div style="overflow-x: auto;">
                    <table class="history-table">
                        <thead>
                            <tr><th>Fecha</th><th>Servicio</th><th>Monto</th><th>Puntos</th></tr>
                        </thead>
                        <tbody id="clientHistory"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="registrar" class="tab-content">
            <h2>üí∞ Registrar Nueva Venta</h2>
            
            <div class="client-search">
                <input type="text" id="saleClientSearch" class="search-box" placeholder="Buscar cliente">
                <button class="btn" onclick="findClientForSale()">Buscar Cliente</button>
            </div>
            
            <div id="saleClientInfo" style="display:none;" class="client-info">
                <p><strong>Cliente:</strong> <span id="saleClientName"></span></p>
                <p><strong>Puntos actuales:</strong> <span id="saleClientPoints"></span></p>
            </div>
            
            <div class="services-grid">
                <div class="service-card">
                    <div class="service-title">üìÑ Impresi√≥n B/N</div>
                    <div class="service-points">1 punto cada $50</div>
                    <input type="number" class="price-input" id="bn-price" placeholder="Monto ($)">
                    <button class="btn" onclick="calculatePoints('bn')">Calcular</button>
                </div>
                <div class="service-card">
                    <div class="service-title">üåà Impresi√≥n Color</div>
                    <div class="service-points">1 punto cada $50</div>
                    <input type="number" class="price-input" id="color-price" placeholder="Monto ($)">
                    <button class="btn" onclick="calculatePoints('color')">Calcular</button>
                </div>
                <div class="service-card">
                    <div class="service-title">üìã Con Anillado</div>
                    <div class="service-points">1 punto cada $50</div>
                    <input type="number" class="price-input" id="anillado-price" placeholder="Monto ($)">
                    <button class="btn" onclick="calculatePoints('anillado')">Calcular</button>
                </div>
                <div class="service-card">
                    <div class="service-title">‚ú® Papel Especial</div>
                    <div class="service-points">1 punto cada $50 ‚Ä¢ +25% si >$2000</div>
                    <input type="number" class="price-input" id="especial-price" placeholder="Monto ($)">
                    <button class="btn" onclick="calculatePoints('especial')">Calcular</button>
                </div>
                <div class="service-card">
                    <div class="service-title">üè≠ Trabajo Offset</div>
                    <div class="service-points">1 punto cada $50 ‚Ä¢ +50% siempre</div>
                    <input type="number" class="price-input" id="offset-price" placeholder="Monto ($)">
                    <button class="btn" onclick="calculatePoints('offset')">Calcular</button>
                </div>
            </div>
            
            <div id="pointsCalculation" style="display:none;" class="points-calculation">
                <h3>üíé C√°lculo de Puntos</h3>
                <p><strong>Servicio:</strong> <span id="calcService"></span></p>
                <p><strong>Monto:</strong> $<span id="calcAmount"></span></p>
                <p><strong>Puntos base:</strong> <span id="calcBase"></span></p>
                <p><strong>Bonificaci√≥n:</strong> <span id="calcBonus"></span></p>
                <p><strong>Total puntos:</strong> <span id="calcTotal"></span> puntos</p>
                <button class="btn" onclick="confirmSale()">‚úÖ Confirmar Venta</button>
                <button class="btn btn-secondary" onclick="cancelSale()">‚ùå Cancelar</button>
            </div>
        </div>
        
        <div id="recompensas" class="tab-content">
            <h2>üéÅ Cat√°logo de Recompensas</h2>
            <div class="rewards-grid">
                <div class="reward-card">
                    <div class="reward-points">200 pts</div>
                    <h3>50 Copias B/N Gratis</h3>
                </div>
                <div class="reward-card">
                    <div class="reward-points">400 pts</div>
                    <h3>15% Descuento</h3>
                </div>
                <div class="reward-card">
                    <div class="reward-points">600 pts</div>
                    <h3>Anillado Gratis</h3>
                </div>
                <div class="reward-card">
                    <div class="reward-points">800 pts</div>
                    <h3>100 Copias Color Gratis</h3>
                </div>
                <div class="reward-card">
                    <div class="reward-points">1000 pts</div>
                    <h3>25% Descuento Premium</h3>
                </div>
                <div class="reward-card">
                    <div class="reward-points">1500 pts</div>
                    <h3>Dise√±o B√°sico Gratis</h3>
                </div>
            </div>
            
            <div style="margin-top: 40px; text-align: center;">
                <h3>üîÑ Canjear Recompensa</h3>
                <input type="text" id="redeemClient" class="search-box" placeholder="Tel√©fono del cliente">
                <select class="search-box" id="redeemReward">
                    <option value="">Seleccionar recompensa...</option>
                    <option value="200">50 Copias B/N Gratis (200 pts)</option>
                    <option value="400">15% Descuento (400 pts)</option>
                    <option value="600">Anillado Gratis (600 pts)</option>
                    <option value="800">100 Copias Color Gratis (800 pts)</option>
                    <option value="1000">25% Descuento Premium (1000 pts)</option>
                    <option value="1500">Dise√±o B√°sico Gratis (1500 pts)</option>
                </select>
                <button class="btn" onclick="redeemReward()">üéÅ Canjear</button>
            </div>
        </div>
        
        <div id="admin" class="tab-content">
            <h2>üìä Panel de Administraci√≥n</h2>
            <div id="adminLoading" class="loading">üîÑ Cargando...</div>
            <div id="adminContent" style="display:none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalClients">0</div>
                        <div class="stat-label">Clientes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalSales">$0</div>
                        <div class="stat-label">Ventas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalPoints">0</div>
                        <div class="stat-label">Puntos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeClients">0</div>
                        <div class="stat-label">Activos</div>
                    </div>
                </div>
                <h3>üëë Top Clientes</h3>
                <table class="history-table">
                    <thead><tr><th>Cliente</th><th>Puntos</th><th>Gastado</th><th>Compras</th></tr></thead>
                    <tbody id="topClients"></tbody>
                </table>
                <button class="btn" onclick="refreshData()">üîÑ Actualizar</button>
                <button class="btn btn-secondary" onclick="viewSheet()">üìä Ver Sheet</button>
            </div>
        </div>
    </div>

    <script>
        let API_URL = '';
        let isConfigured = false;
        let clientsCache = [];
        let currentSaleClient = null;
        let pendingSale = null;
        
        window.onload = function() {
            loadApiConfig();
            if (isConfigured) {
                updateBanner(true);
            } else {
                showTab('config');
            }
        };
        
        function loadApiConfig() {
            const saved = localStorage.getItem('api_url');
            if (saved) {
                API_URL = saved;
                document.getElementById('apiUrl').value = saved;
                isConfigured = true;
                updateBanner(true);
            }
        }
        
        function saveApiConfig() {
            const url = document.getElementById('apiUrl').value.trim();
            if (!url) {
                alert('Ingresa la URL de tu API');
                return;
            }
            API_URL = url;
            localStorage.setItem('api_url', url);
            isConfigured = true;
            updateBanner(true);
            document.getElementById('configStatus').innerHTML = '<div style="color:green;padding:15px;background:#d4edda;border-radius:8px;margin-top:15px;">‚úÖ API guardada correctamente</div>';
        }
        
        function updateBanner(connected) {
            const banner = document.getElementById('configBanner');
            if (connected) {
                banner.innerHTML = '‚úÖ Sistema 100% funcional - Conectado a Google Sheets';
                banner.className = 'config-banner connected';
            }
        }
        
        async function testApi() {
            if (!API_URL) {
                alert('Primero guarda la configuraci√≥n');
                return;
            }
            
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('configStatus').innerHTML = '<div style="color:green;padding:15px;background:#d4edda;border-radius:8px;margin-top:15px;">‚úÖ API funcionando correctamente</div>';
                } else {
                    throw new Error('API no responde');
                }
            } catch (error) {
                document.getElementById('configStatus').innerHTML = '<div style="color:red;padding:15px;background:#f8d7da;border-radius:8px;margin-top:15px;">‚ùå Error conectando con API</div>';
            }
        }
        
        async function callApi(action, data = {}) {
            if (!isConfigured) {
                alert('Configura la API primero');
                return null;
            }
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, ...data })
                });
                return await response.json();
            } catch (error) {
                console.error('Error API:', error);
                return null;
            }
        }
        
        function showTab(tab) {
            if (tab !== 'config' && !isConfigured) {
                alert('Configura la API primero');
                return;
            }
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.querySelector(`[onclick="showTab('${tab}')"]`).classList.add('active');
            document.getElementById(tab).style.display = 'block';
            
            if (tab === 'admin') updateAdminStats();
        }
        
        async function searchClient() {
            const term = document.getElementById('searchClient').value.trim();
            if (!term) {
                alert('Ingresa un t√©rmino de b√∫squeda');
                return;
            }
            
            document.getElementById('searchLoading').style.display = 'block';
            document.getElementById('clientResult').style.display = 'none';
            
            const result = await callApi('getClient', { search: term });
            document.getElementById('searchLoading').style.display = 'none';
            
            if (result && result.success) {
                displayClientInfo(result.data);
            } else {
                alert('Cliente no encontrado');
            }
        }
        
        function displayClientInfo(client) {
            document.getElementById('clientResult').style.display = 'block';
            document.getElementById('clientName').textContent = client.name;
            document.getElementById('clientPoints').textContent = client.points;
            document.getElementById('clientPhone').textContent = client.phone;
            document.getElementById('clientEmail').textContent = client.email;
            document.getElementById('clientTotal').textContent = client.totalSpent.toLocaleString();
            document.getElementById('clientPurchases').textContent = client.purchases;
            
            const rewards = [200, 400, 600, 800, 1000, 1500];
            const nextReward = rewards.find(r => r > client.points) || rewards[rewards.length - 1];
            document.getElementById('nextReward').textContent = Math.max(0, nextReward - client.points);
            
            const historyTable = document.getElementById('clientHistory');
            if (client.history && client.history.length > 0) {
                historyTable.innerHTML = client.history.map(h => `
                    <tr>
                        <td>${h.date}</td>
                        <td>${h.service}</td>
                        <td>$${h.amount.toLocaleString()}</td>
                        <td>${h.points > 0 ? '+' : ''}${h.points}</td>
                    </tr>
                `).join('');
            } else {
                historyTable.innerHTML = '<tr><td colspan="4">Sin historial</td></tr>';
            }
        }
        
        function showAddClientForm() {
            document.getElementById('addClientForm').style.display = 'block';
        }
        
        function cancelAddClient() {
            document.getElementById('addClientForm').style.display = 'none';
            document.getElementById('newClientName').value = '';
            document.getElementById('newClientPhone').value = '';
            document.getElementById('newClientEmail').value = '';
        }
        
        async function addNewClient() {
            const name = document.getElementById('newClientName').value.trim();
            const phone = document.getElementById('newClientPhone').value.trim();
            const email = document.getElementById('newClientEmail').value.trim();
            
            if (!name || !phone) {
                alert('Nombre y tel√©fono son obligatorios');
                return;
            }
            
            const result = await callApi('addClient', { name, phone, email });
            
            if (result && result.success) {
                alert('Cliente agregado exitosamente');
                cancelAddClient();
            } else {
                alert('Error agregando cliente');
            }
        }
        
        async function findClientForSale() {
            const term = document.getElementById('saleClientSearch').value.trim();
            if (!term) {
                alert('Ingresa un t√©rmino de b√∫squeda');
                return;
            }
            
            const result = await callApi('getClient', { search: term });
            
            if (result && result.success) {
                currentSaleClient = result.data;
                document.getElementById('saleClientInfo').style.display = 'block';
                document.getElementById('saleClientName').textContent = currentSaleClient.name;
                document.getElementById('saleClientPoints').textContent = currentSaleClient.points;
            } else {
                alert('Cliente no encontrado');
            }
        }
        
        function calculatePoints(service) {
            const amount = parseFloat(document.getElementById(service + '-price').value);
            if (!amount || amount <= 0) {
                alert('Ingresa un monto v√°lido');
                return;
            }
            
            const basePoints = Math.floor(amount / 50);
            let bonus = 0;
            let bonusText = 'Sin bonificaci√≥n';
            
            if (service === 'offset') {
                bonus = Math.floor(basePoints * 0.5);
                bonusText = '+50% por trabajo offset';
            } else if (service === 'especial' && amount > 2000) {
                bonus = Math.floor(basePoints * 0.25);
                bonusText = '+25% por pedido >$2000';
            }
            
            const totalPoints = basePoints + bonus;
            
            document.getElementById('pointsCalculation').style.display = 'block';
            document.getElementById('calcService').textContent = getServiceName(service);
            document.getElementById('calcAmount').textContent = amount.toLocaleString();
            document.getElementById('calcBase').textContent = basePoints;
            document.getElementById('calcBonus').textContent = bonusText + (bonus > 0 ? ` (+${bonus})` : '');
            document.getElementById('calcTotal').textContent = totalPoints;
            
            pendingSale = { service: getServiceName(service), amount, points: totalPoints };
        }
        
        function getServiceName(service) {
            const names = {
                'bn': 'Impresi√≥n B/N',
                'color': 'Impresi√≥n Color',
                'anillado': 'Con Anillado',
                'especial': 'Papel Especial',
                'offset': 'Trabajo Offset'
            };
            return names[service] || service;
        }
        
        async function confirmSale() {
            if (!currentSaleClient || !pendingSale) {
                alert('Selecciona cliente y calcula puntos primero');
                return;
            }
            
            // Actualizar cliente
            const newPoints = currentSaleClient.points + pendingSale.points;
            const newTotal = currentSaleClient.totalSpent + pendingSale.amount;
            const newPurchases = currentSaleClient.purchases + 1;
            
            // Actualizar en Google Sheets
            const updateResult = await callApi('updateClient', {
                id: currentSaleClient.id,
                points: newPoints,
                totalSpent: newTotal,
                purchases: newPurchases
            });
            
            // Agregar al historial
            const historyResult = await callApi('addHistory', {
                clientId: currentSaleClient.id,
                service: pendingSale.service,
                amount: pendingSale.amount,
                points: pendingSale.points,
                type: 'venta'
            });
            
            if (updateResult && updateResult.success && historyResult && historyResult.success) {
                alert(`¬°Venta registrada! ${currentSaleClient.name} ahora tiene ${newPoints} puntos.`);
                
                // Limpiar formulario
                document.getElementById('pointsCalculation').style.display = 'none';
                document.getElementById('saleClientInfo').style.display = 'none';
                document.getElementById('saleClientSearch').value = '';
                document.querySelectorAll('.price-input').forEach(input => input.value = '');
                
                currentSaleClient = null;
                pendingSale = null;
            } else {
                alert('Error guardando la venta');
            }
        }
        
        function cancelSale() {
            document.getElementById('pointsCalculation').style.display = 'none';
            pendingSale = null;
        }
        
        async function redeemReward() {
            const clientPhone = document.getElementById('redeemClient').value.trim();
            const rewardPoints = parseInt(document.getElementById('redeemReward').value);
            
            if (!clientPhone || !rewardPoints) {
                alert('Completa todos los campos');
                return;
            }
            
            const clientResult = await callApi('getClient', { search: clientPhone });
            
            if (!clientResult || !clientResult.success) {
                alert('Cliente no encontrado');
                return;
            }
            
            const client = clientResult.data;
            
            if (client.points < rewardPoints) {
                alert(`El cliente solo tiene ${client.points} puntos, necesita ${rewardPoints}`);
                return;
            }
            
            // Procesar canje
            const newPoints = client.points - rewardPoints;
            
            const updateResult = await callApi('updateClient', {
                id: client.id,
                points: newPoints,
                totalSpent: client.totalSpent,
                purchases: client.purchases
            });
            
            const historyResult = await callApi('addHistory', {
                clientId: client.id,
                service: 'Canje de recompensa',
                amount: 0,
                points: -rewardPoints,
                type: 'canje'
            });
            
            if (updateResult && updateResult.success && historyResult && historyResult.success) {
                alert(`¬°Recompensa canjeada! ${client.name} ahora tiene ${newPoints} puntos.`);
                document.getElementById('redeemClient').value = '';
                document.getElementById('redeemReward').value = '';
            } else {
                alert('Error procesando el canje');
            }
        }
        
        async function updateAdminStats() {
            document.getElementById('adminLoading').style.display = 'block';
            document.getElementById('adminContent').style.display = 'none';
            
            const clientsResult = await callApi('getClients');
            
            if (clientsResult && clientsResult.success) {
                const clients = clientsResult.data;
                clientsCache = clients;
                
                // Calcular estad√≠sticas
                const totalClients = clients.length;
                const totalSales = clients.reduce((sum, c) => sum + c.totalSpent, 0);
                const totalPoints = clients.reduce((sum, c) => sum + c.points, 0);
                const activeClients = clients.filter(c => c.purchases > 0).length;
                
                // Actualizar UI
                document.getElementById('totalClients').textContent = totalClients;
                document.getElementById('totalSales').textContent = '
             + totalSales.toLocaleString();
                document.getElementById('totalPoints').textContent = totalPoints.toLocaleString();
                document.getElementById('activeClients').textContent = activeClients;
                
                // Top clientes
                const topClients = [...clients]
                    .sort((a, b) => b.points - a.points)
                    .slice(0, 10);
                
                document.getElementById('topClients').innerHTML = topClients.map(c => `
                    <tr>
                        <td>${c.name}</td>
                        <td>${c.points}</td>
                        <td>${c.totalSpent.toLocaleString()}</td>
                        <td>${c.purchases}</td>
                    </tr>
                `).join('');
            }
            
            document.getElementById('adminLoading').style.display = 'none';
            document.getElementById('adminContent').style.display = 'block';
        }
        
        async function refreshData() {
            clientsCache = [];
            await updateAdminStats();
            alert('Datos actualizados desde Google Sheets');
        }
        
        function viewSheet() {
            if (API_URL) {
                // Extraer SHEET_ID de la URL del script si es posible
                window.open('https://sheets.google.com', '_blank');
            }
        }
    </script>
</body>
</html>
